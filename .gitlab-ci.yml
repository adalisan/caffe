image: gcc

#cache: 
#  paths:
#  - linux-centos6/lib
#  - linux-centos6/include
  
stages:
  - build_dep
  - build
  - test  

build_dep:
  stage: build_dep
  before_script:
  - source ./scripts/gitlab_ci/defaults.sh
  - chmod +x ./scripts/gitlab_ci/build-deps-from-source-centos6.sh
  - export BUILD_DIR=$(pwd -P)
  - export FIND_BUILD_DIR=$(find /export/u10/builds -type d -name "caffe")
  script:
  - ./scripts/gitlab_ci/build-deps-from-source-centos6.sh  $BUILD_DIR $FIND_BUILD_DIR
#  cache:
#    paths:
#    - linux-centos6/protobuf*
#    - linux-centos6/snappy*
#    - linux-centos6/boost*
#    - linux-centos6/*.tar.gz
#    - linux-centos6/lib
#    - linux-centos6/include



build:
  stage: build
  before_script:
  - source ./scripts/gitlab_ci/defaults.sh
#  - chmod +x ./scripts/gitlab_ci/build-deps-from-source-centos6.sh
#  - ./scripts/gitlab_ci/build-deps-from-source-centos6.sh 
  script:
  #- make all
  #- make test
  #- make runtest
  - ./scripts/gitlab_ci/setup-venv.sh ~/venv

  - source ~/venv/bin/activate
  - ./scripts/gitlab_ci/install-python-deps.sh
  - ./scripts/gitlab_ci/configure.sh
  - echo "INCLUDE_DIRS :=  `pwd`/linux-centos6/include \$(PYTHON_INCLUDE) \$(INCLUDE_DIRS)" >> Makefile.config
  - echo "LIBRARY_DIRS :=  `pwd`/linux-centos6/lib \$(PYTHON_LIB) \$(LIBRARY_DIRS)" >> Makefile.config
  - echo "BLAS_INCLUDE := `pwd`/linux-centos6/include" >> Makefile.config
  - echo "BLAS_LIB :=  `pwd`/linux-centos6/lib" >> Makefile.config
  - echo "CUDA_DIR := /opt/cuda-6.0" >> Makefile.config
  - echo "PROTOBUF_LIBRARY := `pwd`/linux-centos6/lib/libprotobuf.so" >> Makefile.config
  - echo "PROTOBUF_INCLUDE_DIR := `pwd`/linux-centos6/include" >> Makefile.config
  - echo "PROTOBUF_LIB := `pwd`/linux-centos6/include/lib" >> Makefile.config
  - cat Makefile.config
  - ls /opt/
  - NUM_THREADS=1 ./scripts/gitlab_ci/build.sh
  artifacts:
    paths:
    - build
    - distribute

test:
  stage: test
  script:
  - ./scripts/gitlab_ci/test.sh
  